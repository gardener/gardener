services:
  bind9:
    container_name: bind9
    image: europe-docker.pkg.dev/gardener-project/releases/3rd/ubuntu/bind9:9.18-22.04_beta
    restart: unless-stopped
    ports:
      - "172.18.255.53:53:53/tcp"
      - "172.18.255.53:53:53/udp"
      - "[fd00:ff::53]:53:53/tcp"
      - "[fd00:ff::53]:53:53/udp"
    volumes:
      # Mount the config as read-only.
      - ./bind:/etc/bind:ro
      # Mount the volume storing the zone state (ensure persistence across container restarts).
      # We don't want bind to update our zone files on the host (resulting in git changes and persistence after stopping
      # the local setup). Instead, we copy the zone file to the volume on start up and destroy the volume when running
      # `docker compose down`.
      # This way, we persist the zone state until – and only until – the local setup is stopped.
      - bind9-zones:/var/lib/bind
    command: >
      /bin/sh -c
      "cp /etc/bind/db.local.gardener.cloud /var/lib/bind/db.local.gardener.cloud &&
      chown bind:bind /var/lib/bind/db.local.gardener.cloud &&
      /usr/sbin/named -g -u bind"
    networks:
      kind:
  registry:
    container_name: registry
    image: europe-docker.pkg.dev/gardener-project/releases/3rd/registry:3.0.0
    restart: unless-stopped
    ports:
      - "5001:5001"
    volumes:
      - ../../dev/local-registry/localhost:/var/lib/registry
      - ./registry/config.yaml:/etc/distribution/config.yml
    networks:
      kind:
        aliases:
          - registry.local.gardener.cloud
  registry-cache-gcr:
    container_name: registry-cache-gcr
    image: europe-docker.pkg.dev/gardener-project/releases/3rd/registry:3.0.0
    restart: unless-stopped
    environment:
      REGISTRY_PROXY_REMOTEURL: https://gcr.io
    volumes:
      - ../../dev/local-registry/gcr:/var/lib/registry
      - ./registry/config.yaml:/etc/distribution/config.yml
    networks:
      kind:
        aliases:
          - gcr.registry-cache.local.gardener.cloud
  registry-cache-k8s:
    container_name: registry-cache-k8s
    image: europe-docker.pkg.dev/gardener-project/releases/3rd/registry:3.0.0
    restart: unless-stopped
    environment:
      REGISTRY_PROXY_REMOTEURL: https://registry.k8s.io
    volumes:
      - ../../dev/local-registry/k8s:/var/lib/registry
      - ./registry/config.yaml:/etc/distribution/config.yml
    networks:
      kind:
        aliases:
          - k8s.registry-cache.local.gardener.cloud
  registry-cache-quay:
    container_name: registry-cache-quay
    image: europe-docker.pkg.dev/gardener-project/releases/3rd/registry:3.0.0
    restart: unless-stopped
    environment:
      REGISTRY_PROXY_REMOTEURL: https://quay.io
    volumes:
      - ../../dev/local-registry/quay:/var/lib/registry
      - ./registry/config.yaml:/etc/distribution/config.yml
    networks:
      kind:
        aliases:
          - quay.registry-cache.local.gardener.cloud
  registry-cache-europe-docker-pkg-dev:
    container_name: registry-cache-europe-docker-pkg-dev
    image: europe-docker.pkg.dev/gardener-project/releases/3rd/registry:3.0.0
    restart: unless-stopped
    environment:
      REGISTRY_PROXY_REMOTEURL: https://europe-docker.pkg.dev
    volumes:
      - ../../dev/local-registry/europe-docker-pkg-dev:/var/lib/registry
      - ./registry/config.yaml:/etc/distribution/config.yml
    networks:
      kind:
        aliases:
          - europe-docker-pkg-dev.registry-cache.local.gardener.cloud
networks:
  kind:
    external: true
volumes:
  bind9-zones:
