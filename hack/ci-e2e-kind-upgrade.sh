#!/usr/bin/env bash
#
# SPDX-FileCopyrightText: SAP SE or an SAP affiliate company and Gardener contributors
#
# SPDX-License-Identifier: Apache-2.0

set -o nounset
set -o pipefail
set -o errexit

source $(dirname "${0}")/ci-common.sh

VERSION="$(cat VERSION)"
CLUSTER_NAME=""
SEED_NAME=""

ensure_local_gardener_cloud_hosts

# copy_kubeconfig_from_kubeconfig_env_var copies the kubeconfig to appropriate location based on kind setup
function copy_kubeconfig_from_kubeconfig_env_var() {
  case "$SHOOT_FAILURE_TOLERANCE_TYPE" in
  node)
    cp $KIND_KUBECONFIG dev-setup/gardenlet/components/kubeconfigs/seed-local/kubeconfig
    cp $KIND_KUBECONFIG example/gardener-local/kind/multi-zone/kubeconfig
    ;;
  zone)
    cp $KIND_KUBECONFIG dev-setup/gardenlet/components/kubeconfigs/seed-local/kubeconfig
    cp $KIND_KUBECONFIG example/gardener-local/kind/multi-zone/kubeconfig
    ;;
  *)
    cp $KUBECONFIG example/provider-local/seed-kind/base/kubeconfig
    cp $KUBECONFIG example/gardener-local/kind/local/kubeconfig
    ;;
  esac
}

function gardener_up() {
  # TODO(timebertt): remove sed and SKAFFOLD_DEFAULT_REPO override after v1.134 has been released
  # see https://prow.gardener.cloud/view/gs/gardener-prow/pr-logs/pull/gardener_gardener/13551/pull-gardener-e2e-kind-upgrade/1993794625793429504
  sed -i 's|garden.local.gardener.cloud:5001|registry.local.gardener.cloud:5000|g' skaffold*.yaml
  case "$SHOOT_FAILURE_TOLERANCE_TYPE" in
  node)
    make operator-seed-up SKAFFOLD_DEFAULT_REPO=registry.local.gardener.cloud:5000
    ;;
  zone)
    make operator-seed-up SKAFFOLD_DEFAULT_REPO=registry.local.gardener.cloud:5000
    ;;
  *)
    make gardener-up SKAFFOLD_DEFAULT_REPO=registry.local.gardener.cloud:5000
    ;;
  esac
}

function gardener_down() {
  case "$SHOOT_FAILURE_TOLERANCE_TYPE" in
  node)
    make operator-seed-down
    ;;
  zone)
    make operator-seed-down
    ;;
  *)
    make gardener-down
    ;;
  esac
}

function kind_up() {
  case "$SHOOT_FAILURE_TOLERANCE_TYPE" in
  node)
    make kind-multi-node-up
    ;;
  zone)
    make kind-multi-zone-up
    ;;
  *)
    make kind-up
    ;;
  esac
}

function kind_down() {
  case "$SHOOT_FAILURE_TOLERANCE_TYPE" in
  node)
    make kind-multi-node-down
    ;;
  zone)
    make kind-multi-zone-down
    ;;
  *)
    make kind-down
    ;;
  esac
}

function install_previous_release() {
  pushd $GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases/$GARDENER_PREVIOUS_RELEASE >/dev/null
  copy_kubeconfig_from_kubeconfig_env_var
  migrate_kind_network_range
  configure_node_mirror_new_local_registry
  gardener_up
  popd >/dev/null
}

# TODO(timebertt): Remove this after v1.134 has been released.
# See https://prow.gardener.cloud/view/gs/gardener-prow/pr-logs/pull/gardener_gardener/13549/pull-gardener-e2e-kind-upgrade/1993723553601556480
# and https://gcsweb.prow.gardener.cloud/gcs/gardener-prow/pr-logs/pull/gardener_gardener/13549/pull-gardener-e2e-kind-upgrade/1993723553601556480/artifacts/gardener-local/gardener-local-control-plane/pods/garden_gardenlet-6c9469b889-68grv_ecd815cd-f5fb-4f8a-93e5-f07b97809d95/gardenlet/6.log
function migrate_kind_network_range() {
  sed -i 's|172.18.0.0/16|172.18.0.0/24|g' dev-setup/garden/base/garden.yaml dev-setup/gardenlet/base/gardenlet.yaml example/gardener-local/gardenlet/values.yaml
}

# TODO(timebertt): Remove this after v1.134 has been released.
# See https://prow.gardener.cloud/view/gs/gardener-prow/pr-logs/pull/gardener_gardener/13551/pull-gardener-e2e-kind-upgrade/1994379234188988416
# and https://gcsweb.prow.gardener.cloud/gcs/gardener-prow/pr-logs/pull/gardener_gardener/13551/pull-gardener-e2e-kind-upgrade/1994379234188988416/artifacts/shoot--local--e2e-upgrade/machine-shoot--local--e2e-upgrade-local-68bbd-8wwvp/journal.log
function configure_node_mirror_new_local_registry() {
  # Get the directory of the new gardener version from the directory stack
  # (the original directory of the job before doing pushd)
  next_version_dir="$(dirs -l +1)"
  # copy the new registry mirror config in the node image to the previous version's source code
  # this is necessary because we already push the images to the new local registry (see the SKAFFOLD_DEFAULT_REPO hack above)
  # and need to configure containerd to use HTTP for pulling from the local registry
  cp "$next_version_dir/pkg/provider-local/node/Dockerfile" "$PWD/pkg/provider-local/node"
  cp -r "$next_version_dir/pkg/provider-local/node/containerd/registry.local.gardener.cloud_5000" "$PWD/pkg/provider-local/node/containerd"
}

function upgrade_to_next_release() {
  # downloads and upgrades to GARDENER_NEXT_RELEASE release if GARDENER_NEXT_RELEASE is not same as version mentioned in VERSION file.
  # if GARDENER_NEXT_RELEASE is same as version mentioned in VERSION file then it is considered as local release and install gardener from local repo.
  if [[ -n $GARDENER_NEXT_RELEASE && $GARDENER_NEXT_RELEASE != $VERSION ]]; then
    # download gardener next release to perform gardener upgrade tests
    $(dirname "${0}")/download_gardener_source_code.sh --gardener-version $GARDENER_NEXT_RELEASE --download-path $GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases
    export GARDENER_NEXT_VERSION="$(cat $GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases/$GARDENER_NEXT_RELEASE/VERSION)"
    pushd $GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases/$GARDENER_NEXT_RELEASE >/dev/null
    copy_kubeconfig_from_kubeconfig_env_var
    gardener_up
    popd >/dev/null
  else
    export GARDENER_NEXT_VERSION=$VERSION
    gardener_up
  fi
}

function set_gardener_upgrade_version_env_variables() {
  if [[ -z "$GARDENER_PREVIOUS_RELEASE" ]]; then
    previous_minor_version=$(echo "$VERSION" | awk -F. '{printf("%s.%d", $1, $2-1)}')
    pre_previous_minor_version=$(echo "$previous_minor_version" | awk -F. '{printf("%s.%d", $1, $2-1)}')
    # List all the tags that match the previous minor version pattern
    tag_list=$(git tag -l "${previous_minor_version}.*")
    tag_list_pre=$(git tag -l "${pre_previous_minor_version}.*")

    # Find the most recent tag for the previous minor version
    if [ "$tag_list" ]; then
      export GARDENER_PREVIOUS_RELEASE=$(echo "$tag_list" | tail -n 1)
    # Try to use release branch of previous version as backup
    elif [ "$(git ls-remote https://github.com/gardener/gardener release-"${previous_minor_version}")" ]; then
      export GARDENER_PREVIOUS_RELEASE="release-${previous_minor_version}"
      echo "No tags found for the previous minor version ($VERSION) to upgrade Gardener. Using branch $GARDENER_PREVIOUS_RELEASE instead." >&2
    # If the release branch is found neither, use the tag of the pre previous version as last resort
    elif [ "$tag_list_pre" ]; then
      export GARDENER_PREVIOUS_RELEASE=$(echo "$tag_list_pre" | tail -n 1)
      echo "No tags and branches found for the previous minor version ($VERSION) to upgrade Gardener. Using tag $GARDENER_PREVIOUS_RELEASE instead." >&2
    else
      echo "No tags and release branches found for the previous and pre-previous minor version ($VERSION) to upgrade Gardener." >&2
      exit 1
    fi
  fi

  if [[ -z "$GARDENER_NEXT_RELEASE" ]]; then
    export GARDENER_NEXT_RELEASE="$VERSION"
  fi
}

function set_cluster_name() {
  case "$SHOOT_FAILURE_TOLERANCE_TYPE" in
  node)
    CLUSTER_NAME="gardener-operator-local"
    ;;
  zone)
    CLUSTER_NAME="gardener-operator-local"
    ;;
  *)
    CLUSTER_NAME="gardener-local"
    ;;
  esac
}

function run_pre_upgrade_test() {
  local test_command

  if [[ "$SHOOT_FAILURE_TOLERANCE_TYPE" == "node" || "$SHOOT_FAILURE_TOLERANCE_TYPE" == "zone" ]]; then
    test_command="test-pre-upgrade"
  else
    test_command="test-non-ha-pre-upgrade"
  fi

  make "$test_command" GARDENER_PREVIOUS_RELEASE="$GARDENER_PREVIOUS_RELEASE" GARDENER_NEXT_RELEASE="$GARDENER_NEXT_RELEASE"
}

function run_post_upgrade_test() {
  local test_command

  if [[ "$SHOOT_FAILURE_TOLERANCE_TYPE" == "node" || "$SHOOT_FAILURE_TOLERANCE_TYPE" == "zone" ]]; then
    test_command="test-post-upgrade"
  else
    test_command="test-non-ha-post-upgrade"
  fi

  make "$test_command" GARDENER_PREVIOUS_RELEASE="$GARDENER_PREVIOUS_RELEASE" GARDENER_NEXT_RELEASE="$GARDENER_NEXT_RELEASE"
}

# TODO(rfranzke): Remove this after legacy helm-based dev setup has been dropped.
if [[ "$SHOOT_FAILURE_TOLERANCE_TYPE" == "zone" ]] || [[ "$SHOOT_FAILURE_TOLERANCE_TYPE" == "node" ]]; then
  echo "WARNING: The Gardener upgrade tests for the zone/node failure tolerance types are not executed in this release because the dev/e2e test setup is currently reworked."
  echo "See https://github.com/gardener/gardener/issues/11958 for more information."
  echo "Skipping the tests."
  echo "After the rework has been finished, this early exit can be removed again (TODO(rfranzke))."
  exit 0
fi

clamp_mss_to_pmtu
set_gardener_upgrade_version_env_variables
set_cluster_name
SEED_NAME="local"

# download gardener previous release to perform gardener upgrade tests
$(dirname "${0}")/download_gardener_source_code.sh --gardener-version $GARDENER_PREVIOUS_RELEASE --download-path $GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases
export GARDENER_PREVIOUS_VERSION="$(cat $GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases/$GARDENER_PREVIOUS_RELEASE/VERSION)"

# test setup
kind_up

# export all container logs and events after test execution
trap "
  ( rm -rf "$GARDENER_RELEASE_DOWNLOAD_PATH/gardener-releases" )
  ( export_artifacts "$CLUSTER_NAME" )
  ( kind_down )
" EXIT

echo "Installing gardener version '$GARDENER_PREVIOUS_RELEASE'"
install_previous_release

echo "Running gardener pre-upgrade tests"
run_pre_upgrade_test

echo "Upgrading gardener version '$GARDENER_PREVIOUS_RELEASE' to '$GARDENER_NEXT_RELEASE'"
upgrade_to_next_release

echo "Wait until seed '$SEED_NAME' gets upgraded from version '$GARDENER_PREVIOUS_RELEASE' to '$GARDENER_NEXT_RELEASE'"
kubectl wait seed $SEED_NAME --timeout=5m --for=jsonpath="{.status.gardener.version}=$GARDENER_NEXT_RELEASE"
# TIMEOUT has been increased to 1200 (20 minutes) due to the upgrading of Gardener for seed.
# In a single-zone setup, 2 istio-ingressgateway pods will be running, and it will take 9 minutes to complete the rollout.
# In a multi-zone setup, 6 istio-ingressgateway pods will be running, and it will take 18 minutes to complete the rollout.
TIMEOUT=1200 ./hack/usage/wait-for.sh seed "$SEED_NAME" GardenletReady SeedSystemComponentsHealthy ExtensionsReady BackupBucketsReady

# The downtime validator considers downtime after 3 consecutive failures, taking a total of 30 seconds.
# Therefore, we're waiting for double that amount of time (60s) to detect if there is any downtime after the upgrade process.
# By waiting for double the amount of time (60 seconds) post-upgrade, the script accounts for the possibility of missing the last 30-second window,
# thus ensuring that any potential downtime after the post-upgrade is detected.
sleep 60

echo "Running gardener post-upgrade tests"
run_post_upgrade_test

gardener_down
