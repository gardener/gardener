#!/bin/bash -e
#
# SPDX-FileCopyrightText: 2018 SAP SE or an SAP affiliate company and Gardener contributors
#
# SPDX-License-Identifier: Apache-2.0

source $(dirname "${0}")/common/helpers
source $(dirname "${0}")/common/local-imagevector-overwrite

mktemp_kubeconfig
kubeconfig="$__tmp_kubeconfig"
REPO_ROOT=$(dirname $0)/../..
trap cleanup_kubeconfig EXIT

file_imagevector_overwrite="$(mktemp_imagevector_overwrite github.com/gardener/gardener "$REPO_ROOT" "$REPO_ROOT"/charts)"
if [ ! -f "$file_imagevector_overwrite" ]; then
    echo "failed to generate local image vector override: $file_imagevector_overwrite"
else
  trap cleanup_imagevector_overwrite EXIT

  KUBECONFIG="${KUBECONFIG:-$kubeconfig}" \
  GARDEN_KUBECONFIG="${GARDEN_KUBECONFIG:-$kubeconfig}" \
  IMAGEVECTOR_OVERWRITE="$file_imagevector_overwrite" \
  GO111MODULE=on \
      go run \
        -mod=vendor \
        -ldflags "$("$(dirname $0)"/../get-build-ld-flags.sh)" \
        "$(dirname $0)"/../../cmd/gardenlet/main.go \
        --config="$(dirname $0)"/../../dev/20-componentconfig-gardenlet.yaml
fi
