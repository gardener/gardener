{{- if eq (include "coredns.enabled" .) "true" -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-provider-local-coredns
  namespace: gardener-extension-provider-local-coredns
spec:
  ingress:
  - from:
    # Allow traffic from the docker kind network's gateway IP. This is the source IP seen by NetworkPolicies
    # when using the nodePort port-mapping on the kind control-node node (5353:30053) used by e2e tests and if the
    # coredns pod runs on the control-plane node.
    - ipBlock:
        cidr: 172.18.0.1/32
    # If the coredns pod runs on another node than the control-plane node, incoming traffic on the nodePort gets SNATed
    # by kube-proxy and is then sent over the tunl0 interface to the node where the coredns pod runs. In this case, the
    # source IP seen by NetworkPolicies on the destination node is the node IP of the control-plane node (on the tunl0
    # interface). This IP is allocated from the calico default IPPool (10.1.0.0/16).
    - ipBlock:
        cidr: 10.1.0.0/16
    ports:
    - port: 9053
      protocol: TCP
    - port: 9053
      protocol: UDP
  podSelector:
    matchLabels:
      app: coredns
  policyTypes:
  - Ingress
{{- end -}}
