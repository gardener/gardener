apiVersion: v1
kind: ConfigMap
metadata:
  name: seed-prometheus-config
  namespace: {{ .Release.Namespace }}
data:
  prometheus.yaml: |

    global:
      evaluation_interval: 1m
      scrape_interval: 1m

    scrape_configs:
    - job_name: extensions
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_namespace
        - __meta_kubernetes_pod_annotation_prometheus_io_scrape
        - __meta_kubernetes_pod_annotation_prometheus_io_port
        regex: extension-(.+);true;(.+)
        action: keep
      - source_labels:
        - __address__
        - __meta_kubernetes_pod_annotation_prometheus_io_port
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)

    - job_name: garden
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_namespace
        - __meta_kubernetes_pod_annotation_prometheus_io_scrape
        - __meta_kubernetes_pod_annotation_prometheus_io_port
        regex: garden;true;(.+)
        action: keep
      - source_labels:
        - __address__
        - __meta_kubernetes_pod_annotation_prometheus_io_port
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)

    - job_name: cadvisor
      metrics_path: /federate
      honor_labels: true
      params:
        'match[]':
        - '{job="cadvisor",namespace=~"extension-(.+)"}'
        - '{job="cadvisor",namespace="garden"}'
        - '{job="cadvisor",namespace=~"istio-(.+)"}'
      static_configs:
      - targets:
        - prometheus-web.garden.svc
      metric_relabel_configs:
{{ include "prometheus.keep-metrics.metric-relabel-config" .Values.allowedMetrics.cadvisor | indent 6 }}
